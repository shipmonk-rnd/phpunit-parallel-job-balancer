# PHPUnit Parallel Job Balancer

Balances PHPUnit test execution across parallel jobs based on historical timing data from JUnit XML reports.

This tool helps optimize CI pipelines by distributing tests evenly across parallel runners, minimizing the total execution time.

## Installation

```sh
composer require --dev shipmonk/phpunit-parallel-job-balancer
```

## Usage

### Basic Usage

```sh
vendor/bin/balance-phpunit-jobs junit-reports/*.xml
```

This will output PHPUnit testsuite XML fragments to stdout.

### Options

| Option | Short | Description | Default |
|--------|-------|-------------|---------|
| `--jobs=N` | `-j` | Number of parallel jobs | 16 |
| `--exclude=PATH` | `-e` | Exclude path from output (repeatable) | - |
| `--output=FILE` | `-o` | Write output to file instead of stdout | stdout |
| `--tests-dir=PATH` | - | Base test directory | `./tests` |
| `--help` | `-h` | Show help message | - |
| `--version` | `-V` | Show version | - |

### Examples

```sh
# Balance into 8 parallel jobs
vendor/bin/balance-phpunit-jobs -j 8 junit/*.xml

# With exclusions
vendor/bin/balance-phpunit-jobs \
  --jobs=16 \
  --exclude=./tests/Integration/Slow \
  --exclude=./tests/E2E \
  junit/*.xml

# Output to file
vendor/bin/balance-phpunit-jobs -j 16 -o phpunit-suites.xml junit/*.xml
```

### Example Output

```xml
<testsuite name="part1">
    <!--  45.123 s --><directory>./tests/Unit/Service</directory>
    <!--  12.456 s --><file>./tests/Unit/SpecificTest.php</file>
</testsuite>
<testsuite name="part2">
    <!--  38.789 s --><directory>./tests/Integration</directory>
    <!--  18.234 s --><directory>./tests/Unit/Repository</directory>
</testsuite>
```

## How It Works

1. **Parse JUnit XML reports** - Extracts test file paths and their execution times from JUnit XML format (generated by PHPUnit with `--log-junit` option)

2. **Build timing tree** - Creates a hierarchical tree of test paths where each node accumulates the total execution time of all its children

3. **Greedy bin-packing with tree splitting** - The algorithm:
   - Calculates target time per job (total time / job count)
   - For each node, finds the job with minimum accumulated time
   - If adding the node keeps the job under target OR the node has no children, assigns it to that job
   - Otherwise, splits the node into its children for finer-grained distribution

4. **Generate PHPUnit XML** - Outputs testsuite fragments that can be used to configure parallel PHPUnit runs

## CI Integration

### GitLab CI

```yaml
test:
  parallel: 16
  script:
    - vendor/bin/balance-phpunit-jobs -j 16 -o phpunit-balanced.xml previous-run/*.xml
    - vendor/bin/phpunit --testsuite "part${CI_NODE_INDEX}"
  artifacts:
    reports:
      junit: junit.xml
```

### GitHub Actions

```yaml
jobs:
  test:
    strategy:
      matrix:
        part: [1, 2, 3, 4]
    steps:
      - uses: actions/checkout@v4
      - name: Balance tests
        run: vendor/bin/balance-phpunit-jobs -j 4 -o phpunit-balanced.xml previous-run/*.xml
      - name: Run tests
        run: vendor/bin/phpunit --testsuite "part${{ matrix.part }}"
```

## Comparison with Paratest

[Paratest](https://github.com/paratestphp/paratest) and PHPUnit Parallel Job Balancer solve different problems and can be used together.

| Feature | PHPUnit Parallel Job Balancer | Paratest |
|---------|------------------------------|----------|
| **Purpose** | Distributes tests across CI jobs | Runs tests in parallel processes |
| **Parallelization** | Across machines/containers | Within a single machine |
| **Timing-based balancing** | Yes, uses historical JUnit XML data | Limited (WrapperRunner only) |
| **CI integration** | Native (GitLab CI, GitHub Actions, etc.) | Requires single machine |
| **Test isolation** | Full (separate CI jobs) | Process-level |
| **Scalability** | Scales with CI runners | Limited by CPU cores |
| **Output** | PHPUnit XML configuration | Direct test execution |

### When to use PHPUnit Parallel Job Balancer

- You have multiple CI runners/containers available
- You want to distribute tests evenly based on actual execution times
- You need full isolation between test groups
- Your CI system supports parallel jobs (GitLab CI, GitHub Actions matrix, etc.)

### When to use Paratest

- You want to parallelize tests on a single machine
- You don't have multiple CI runners available
- You need quick local parallel execution

### Using both together

You can combine both tools for maximum parallelization:

```yaml
# GitLab CI example: 4 parallel jobs, each using Paratest with 4 processes
test:
  parallel: 4
  script:
    - vendor/bin/balance-phpunit-jobs -j 4 -o phpunit-balanced.xml previous-run/*.xml
    - vendor/bin/paratest -p 4 --testsuite "part${CI_NODE_INDEX}"
```

This gives you 4 CI jobs Ã— 4 parallel processes = 16-way parallelization.

## Requirements

- PHP 8.1 or higher
- ext-dom
- ext-simplexml

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

MIT License - see [LICENSE](LICENSE) file for details.
